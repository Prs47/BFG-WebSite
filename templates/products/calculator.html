{% extends "base.html" %}
{% load humanize %}
{% block title %}ماشین‌حساب قیمت{% endblock %}

{% block content %}
<div style="max-width:900px;margin:30px auto;padding:16px;">
  <div class="max-w-7xl mx-auto px-4 py-8">
    <h1 class="text-2xl font-bold mb-4">ماشین حساب قیمت</h1>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

  <!-- فرم به صورت client-side عمل می‌کند؛ ارسال به سرور غیر فعال است -->
  <form id="calc-form" method="post" action="#" onsubmit="return false;">
    {% csrf_token %}

    {# همیشه یک hidden برای قیمت داشته باشیم تا JS به آن دسترسی یابد #}
    <input type="hidden" id="price-hidden" name="price_hidden"
           value="{% if selected_product %}{{ selected_product.current_price|floatformat:0 }}{% endif %}">

  <div class="calculator-product-block">
    {% if selected_product %}
      <div style="margin-top:8px;">
        <label>قیمت (از دیتابیس):</label>
        <strong id="price-display">{{ selected_product.current_price|intcomma }}</strong> ریال
        <input id="price" name="price" class="price-input" value="{{ selected_product.current_price|default:'' }}" readonly>
      </div>

      <div style="margin-top:4px;">واحد: <strong id="unit-display">{{ selected_product.unit }}</strong></div>

    {# اگر فرم شامل فیلد price است، آن را غیرفعال کن تا کاربر تغییر ندهد #}
      <div style="display:none;">
        {{ form.price }}
      </div>

    {% else %}
      <div>
        <label for="id_product">انتخاب محصول</label><br>
        <select name="product" id="id_product" style="padding:8px;min-width:300px;">
          <option value="">— انتخاب کنید —</option>
          {% for p in products %}
            {# data-price را به فرمت عددی بدون اعشار بدهیم (برای JS) #}
            <option value="{{ p.slug }}" data-price="{{ p.current_price|floatformat:0 }}" data-unit="{{ p.unit }}">{{ p.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div style="margin-top:8px;">
        <label for="id_price">قیمت (ریال)</label><br>
        {{ form.price }}
      </div>
    {% endif %}
  </div>

    <hr style="margin:18px 0;">

    <!-- بخش: تعداد/وزن -> قیمت -->
    <h3>محاسبه از روی تعداد/وزن → قیمت کل</h3>
    <div>
      <label id="qty-label">تعداد / وزن</label><br>
      {{ form.quantity }}
      <div style="color:#666;font-size:0.9em;">واحد: <span id="unit-note">{% if selected_product %}{{ selected_product.unit }}{% else %}—{% endif %}</span></div>
    </div>

    <div style="margin-top:8px;">
      <button type="button" id="btn-calc-q-to-p">محاسبه قیمت</button>
    </div>

    <!-- نمایش نتیجه برای بخش تعداد→قیمت (زیر همان بخش) -->
    <div id="calc-result-qty" style="margin-top:12px;color:#111;"></div>

    <hr style="margin:18px 0;">

    <!-- بخش: بودجه -> تعداد/وزن -->
    <h3>محاسبه از روی بودجه → تعداد/وزن</h3>
    <div>
      <label>بودجه (ریال)</label><br>
      {{ form.budget }}
    </div>

    <div style="margin-top:8px;">
      <button type="button" id="btn-calc-b-to-q">محاسبه تعداد</button>
    </div>

    <!-- نمایش نتیجه برای بخش بودجه→تعداد (زیر همان بخش) -->
    <div id="calc-result-budget" style="margin-top:12px;color:#111;"></div>

  </form>
</div>
<!-- Tom Select (CDN) -->
<link href="https://cdn.jsdelivr.net/npm/tom-select/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select/dist/js/tom-select.complete.min.js"></script>

<style>
/* light adjustments so TomSelect match current dark input style minimally */
.ts-control, .ts-control .ts-input {
  background: rgba(255,255,255,0.06);   /* keep dark-ish background if your page is dark */
  color: inherit;
  border-radius: 8px;
  padding: 6px 10px;
}
.ts-control .item {
  color: inherit;
}
.ts-dropdown {
  z-index: 9999;
  max-height: 320px;
  overflow: auto;
  background: var(--site-bg-dark, #212121);
  color: #fff;
}
.ts-option {
  padding: 8px 10px;
}
.ts-option .ts-small { font-size: 0.8rem; opacity: .85; margin-left:8px; }
</style>

<style>
/* همان قواعد بالا را اینجا قرار بده (برای تست فوری) */
#price, input.price-input, input[name="price"] { color: #121212 !important; opacity:1 !important; }
#price::placeholder, input.price-input::placeholder { color: rgba(0,0,0,0.45) !important; }
#price[readonly], input.price-input[readonly] { color: #121212 !important; opacity:1 !important; cursor:not-allowed; }
</style>
<script>
document.addEventListener('DOMContentLoaded', function() {
  const select = document.getElementById('id_product');
  const priceInput = document.querySelector('input[name="price"]');
  const priceHidden = document.getElementById('price-hidden');
  const priceDisplay = document.getElementById('price-display');
  const unitNote = document.getElementById('unit-note');
  const unitDisplay = document.getElementById('unit-display');
  const qtyLabel = document.getElementById('qty-label');

  function isWeight(unit) {
    if (!unit) return false;
    const u = String(unit).toLowerCase();
    return u.includes('kg') || u.includes('کیلو') || u.includes('کیلوگرم') || u.includes('تن') || u.includes('ton');
  }

  // formatNumber: default decimals = 0 (for prices), decimals>0 for weights
  function formatNumber(value, decimals = 0) {
    if (value === null || value === undefined || value === '') return '';
    const num = Number(String(value).replace(/,/g, ''));
    if (isNaN(num)) return String(value);
    const opts = { maximumFractionDigits: decimals };
    if (decimals > 0) opts.minimumFractionDigits = decimals;
    return new Intl.NumberFormat('en-US', opts).format(num);
  }

  function setPriceAndUnit(price, unit) {
    // priceInput (editable only if no product selected)
    if (priceInput) {
      if (price === null || price === undefined || price === '') {
        priceInput.removeAttribute('readonly');
        priceInput.style.background = '';
        priceInput.style.cursor = '';
        priceInput.value = '';
      } else {
        priceInput.setAttribute('readonly', 'readonly');
        priceInput.style.background = '#f3f3f3';
        priceInput.style.cursor = 'not-allowed';
        priceInput.value = price;
      }
    }

    // hidden
    if (priceHidden) priceHidden.value = (price === null || price === undefined) ? '' : String(price);

    // display (strong)
    if (priceDisplay) {
      // show integer price with thousands separator
      priceDisplay.innerText = (price === null || price === undefined || price === '') ? '0' : formatNumber(price, 0);
    }

    // units
    if (unitNote) unitNote.innerText = unit || '—';
    if (unitDisplay) unitDisplay.innerText = unit || '';

    // qty label
    if (qtyLabel) {
      if (!unit) {
        qtyLabel.innerText = 'تعداد / وزن';
      } else if (isWeight(unit)) {
        qtyLabel.innerText = 'وزن';
      } else {
        qtyLabel.innerText = 'شاخه';
      }
    }
  }

  function onSelectChange() {
    if (!select) return;
    const opt = select.options[select.selectedIndex];
    if (!opt || !opt.value) {
      setPriceAndUnit('', '');
      return;
    }
    const price = opt.getAttribute('data-price') || '';
    const unit = opt.getAttribute('data-unit') || '';
    // numeric rounding for safety
    const numeric = price !== '' ? Math.round(Number(String(price).replace(/,/g, ''))) : '';
    setPriceAndUnit(numeric, unit);
  }

  // init: if select exists, wire handler; else if server provided selected_product rely on hidden
  if (select) {
    select.addEventListener('change', onSelectChange);
    // trigger initial change if a product is already selected in browser
    if (select.value) {
      onSelectChange();
    } else {
      // ensure price/input state consistent with hidden (if any)
      if (priceHidden && priceHidden.value) {
        setPriceAndUnit(Math.round(Number(String(priceHidden.value).replace(/,/g,''))), unitDisplay ? unitDisplay.innerText : '');
      } else {
        setPriceAndUnit('', '');
      }
    }
  } else {
    // no select — likely server preselected product; set from hidden/display
    if (priceHidden && priceHidden.value) {
      setPriceAndUnit(Math.round(Number(String(priceHidden.value).replace(/,/g,''))), unitDisplay ? unitDisplay.innerText : '');
    }
  }

  // client-side: تعداد -> قیمت
  const btnQty = document.getElementById('btn-calc-q-to-p');
  if (btnQty) {
    btnQty.addEventListener('click', function(){
      const qraw = document.querySelector('[name="quantity"]').value || 0;
      const q = parseFloat(String(qraw).replace(/,/g,'')) || 0;
      const data = (priceHidden && priceHidden.value) ? {price: parseFloat(priceHidden.value||0), unit: (unitDisplay?unitDisplay.innerText:'')} :
                   (select && select.value ? {price: parseFloat(select.options[select.selectedIndex].getAttribute('data-price')||0), unit: select.options[select.selectedIndex].getAttribute('data-unit')||''} :
                   {price: parseFloat((document.querySelector('[name="price"]') ? document.querySelector('[name="price"]').value : 0) || 0), unit: (document.getElementById('unit-note') ? document.getElementById('unit-note').innerText : '')});
      const price = Number(data.price) || 0;
      const unit = data.unit || '';
      let qtyDisplay, totalDisplay, outHTML;

      if (isWeight(unit)) {
        qtyDisplay = Math.round((q + Number.EPSILON) * 100) / 100;
        totalDisplay = Math.round((q * price + Number.EPSILON) * 100) / 100;
        outHTML =
          `<div>تعداد ورودی: <strong>${formatNumber(qtyDisplay,2)}</strong> ${unit}</div>
           <div>قیمت کل: <strong>${formatNumber(totalDisplay,2)}</strong> ریال</div>`;
      } else {
        qtyDisplay = Math.floor(q);
        totalDisplay = Math.floor(qtyDisplay * price);
        outHTML =
          `<div>تعداد ورودی (گرد شده): <strong>${formatNumber(qtyDisplay,0)}</strong> ${unit}</div>
           <div>قیمت کل: <strong>${formatNumber(totalDisplay,0)}</strong> ریال</div>`;
      }

      document.getElementById('calc-result-qty').innerHTML = outHTML;
    });
  }

  // client-side: بودجه -> تعداد
  const btnBudget = document.getElementById('btn-calc-b-to-q');
  if (btnBudget) {
    btnBudget.addEventListener('click', function(){
      const braw = document.querySelector('[name="budget"]').value || 0;
      const b = parseFloat(String(braw).replace(/,/g,'')) || 0;
      const data = (priceHidden && priceHidden.value) ? {price: parseFloat(priceHidden.value||0), unit: (unitDisplay?unitDisplay.innerText:'')} :
                   (select && select.value ? {price: parseFloat(select.options[select.selectedIndex].getAttribute('data-price')||0), unit: select.options[select.selectedIndex].getAttribute('data-unit')||''} :
                   {price: parseFloat((document.querySelector('[name="price"]') ? document.querySelector('[name="price"]').value : 0) || 0), unit: (document.getElementById('unit-note') ? document.getElementById('unit-note').innerText : '')});
      const price = Number(data.price) || 0;
      const unit = data.unit || '';
      if (price === 0) {
        document.getElementById('calc-result-budget').innerHTML = `<div style="color:#b00">قیمت محصول صفر است؛ محاسبه ممکن نیست.</div>`;
        return;
      }

      const raw_qty = b / price;
      let outHTML;
      if (isWeight(unit)) {
        const qty = Math.round((raw_qty + Number.EPSILON) * 100) / 100;
        outHTML =
          `<div>بودجه: <strong>${formatNumber(b,0)}</strong> ریال</div>
           <div>تعداد قابل خرید: <strong>${formatNumber(qty,2)}</strong> ${unit}</div>`;
      } else {
        const qty = Math.floor(raw_qty);
        outHTML =
          `<div>بودجه: <strong>${formatNumber(b,0)}</strong> ریال</div>
           <div>تعداد قابل خرید (گرد به پایین): <strong>${formatNumber(qty,0)}</strong> ${unit}</div>`;
      }
      document.getElementById('calc-result-budget').innerHTML = outHTML;
    });
  }

});

/* === Init TomSelect for #id_product === */
document.addEventListener('DOMContentLoaded', function() {
  // only init if select exists
  const el = document.getElementById('id_product');
  if (!el) return;

  // preserve any existing <option> as initial options (server-side fallback)
  // TomSelect will use AJAX for search/load
  const ts = new TomSelect(el, {
    valueField: "value",        // maps to our JSON.value (slug)
    labelField: "text",
    searchField: ["text"],
    maxOptions: 50,
    loadThrottle: 250,
    preload: true,              // preload initial options (so server-rendered ones available)
    render: {
      option: function(item, escape) {
        // show name and a small price unit
        const price = item.price ? new Intl.NumberFormat('en-US').format(item.price) + ' ریال' : '';
        const unit = item.unit ? ' • ' + escape(item.unit) : '';
        return `<div>${escape(item.text)}<span class="ts-small">${price}${unit}</span></div>`;
      },
      item: function(item, escape) {
        // how selected item looks in the control
        return `<div>${escape(item.text)}</div>`;
      }
    },
    load: function(query, callback) {
      // if empty query, fetch a small list (or return nothing)
      const url = '/api/product-search/?q=' + encodeURIComponent(query || '');
      fetch(url)
        .then(response => response.json())
        .then(json => {
          // our API returns an array
          callback(json);
        })
        .catch(() => {
          callback();
        });
    },
    onChange: function(value) {
      // value is the selected value (slug) or "" when cleared
      if (!value) {
        // clear price/unit so user can type manual price
        if (typeof setPriceAndUnit === 'function') setPriceAndUnit('', '');
        return;
      }
      // get option object from TomSelect internal options map
      const opt = this.options[value];
      if (opt) {
        if (typeof setPriceAndUnit === 'function') {
          // numeric rounding for safety
          const p = opt.price ? Math.round(Number(String(opt.price).replace(/,/g,''))) : '';
          setPriceAndUnit(p, opt.unit || '');
        }
      } else {
        // fallback: fetch the product by slug (API could support lookup by slug)
        fetch(`/api/product-search/?q=${encodeURIComponent(value)}`)
          .then(r => r.json())
          .then(items => {
            const item = (items && items[0]) || null;
            if (item && typeof setPriceAndUnit === 'function') {
              const p = item.price ? Math.round(Number(String(item.price).replace(/,/g,''))) : '';
              setPriceAndUnit(p, item.unit || '');
            }
          })
          .catch(() => {});
      }
    }
  });

  // If server passed a preselected product in hidden, set TomSelect's value
  const initialHidden = document.getElementById('price-hidden');
  if (initialHidden && initialHidden.value) {
    // if you also rendered the selected product slug into select as an option, set it:
    const preSlug = el.querySelector('option[selected]') ? el.querySelector('option[selected]').value : (el.dataset.selected || '');
    if (preSlug) {
      ts.setValue(preSlug);
    }
  }
});
</script>
{% endblock %}
